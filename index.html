<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lets Share Tracks - Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            transition: background 0.5s ease;
        }

        /* Dynamic theme - will be applied via JavaScript inline styles */

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 40px 20px 20px;
            position: relative;
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00d4ff, #7b2ff7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.2em;
            color: #a0a0a0;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }

        .random-track-btn {
            position: absolute;
            top: 60px;
            right: 20px;
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            gap: 6px;
        }

        .random-track-btn.visible {
            display: flex;
        }

        .random-track-btn:hover {
            background: linear-gradient(135deg, #00d4ff, #7b2ff7);
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 212, 255, 0.3);
        }

        .random-track-btn:active {
            transform: scale(0.95);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #00d4ff, #7b2ff7);
            border-color: transparent;
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.5);
        }

        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 100px;
        }

        .music-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            cursor: pointer;
            backdrop-filter: blur(5px);
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .music-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border-color: rgba(0, 212, 255, 0.5);
        }

        .music-item.hidden {
            display: none;
        }

        .album-art {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .item-title {
            font-size: 0.9em;
            margin-bottom: 5px;
            color: #fff;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item-artist {
            font-size: 0.8em;
            color: #a0a0a0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            margin-top: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .badge.bandcamp {
            background: linear-gradient(135deg, #629aa9, #4a7885);
        }

        .badge.youtube {
            background: linear-gradient(135deg, #ff0000, #cc0000);
        }

        #bandcampPlayer {
            position: fixed;
            bottom: -400px;
            left: 0;
            right: 0;
            height: 400px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            transition: bottom 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        #bandcampPlayer.visible {
            bottom: 0;
        }

        #bandcampPlayer.sidebar-mode {
            position: fixed;
            top: 0;
            left: auto;
            right: -500px;
            bottom: 0;
            width: 500px;
            height: 100vh;
            border-top: none;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            transition: right 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #bandcampPlayer.sidebar-mode.visible {
            right: 0;
            bottom: 0;
        }

        body.sidebar-active {
            margin-right: 500px;
            transition: margin-right 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #playerLabel {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            font-size: 0.9em;
            color: #a0a0a0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .player-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 0 5px;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .player-close:hover {
            opacity: 1;
        }

        #bandcampIframe, #youtubeIframe {
            width: 100%;
            flex: 1;
            border: none;
        }

        #bandcampIframe.album-player {
            height: calc(100% - 50px);
        }

        #youtubeIframe {
            display: none;
        }

        /* Gradient backgrounds */
        .gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .gradient-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .gradient-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .gradient-6 { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        .gradient-7 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .gradient-8 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }

        /* Tag system */
        .tag-container {
            margin: 20px 0;
            text-align: center;
            padding: 0 20px;
        }

        .tag-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }

        .tag-chip {
            padding: 5px 12px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tag-chip:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tag-chip.active {
            background: linear-gradient(135deg, #00d4ff, #7b2ff7);
            border-color: transparent;
            box-shadow: 0 3px 10px rgba(0, 212, 255, 0.4);
        }

        .clear-tags {
            padding: 5px 12px;
            border-radius: 15px;
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #fff;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-tags:hover {
            background: rgba(255, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        .items-count {
            text-align: center;
            margin: 10px 0;
            color: #a0a0a0;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            
            .music-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 15px;
            }

            .theme-toggle, .random-track-btn {
                padding: 6px 12px;
                font-size: 0.8em;
            }

            .random-track-btn {
                top: 55px;
                right: 10px;
            }

            #bandcampPlayer {
                height: 350px;
            }

            #bandcampPlayer.sidebar-mode {
                width: 100%;
                right: -100%;
            }

            #bandcampPlayer.sidebar-mode.visible {
                right: 0;
            }

            body.sidebar-active {
                margin-right: 0;
            }
        }

        /* Loading indicator */
        .loading {
            text-align: center;
            padding: 50px;
            color: #a0a0a0;
        }

        .loading:after {
            content: '.';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        /* Debug info panel */
        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 5px;
            max-width: 300px;
            display: none;
            z-index: 2000;
        }

        .debug-info.show {
            display: block;
        }

        .debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            border: 1px solid #333;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            z-index: 1999;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Let's Share Tracks</h1>
            <p class="subtitle">Community Music Collection - Enhanced</p>
            <button class="theme-toggle" id="themeToggle">
                üé® <span>Theme</span>
            </button>
            <button class="random-track-btn" id="randomTrackBtn">
                üé≤ <span>Random Track</span>
            </button>
        </header>

        <div class="tag-container">
            <div id="tagInfo" style="color: #a0a0a0; font-size: 0.9em; margin-bottom: 10px;">
                Loading tags...
            </div>
            <div id="tagFilters" class="tag-filters"></div>
        </div>

        <div class="controls">
            <button class="filter-btn active" data-filter="all">
                All Sources <span id="allCount"></span>
            </button>
            <button class="filter-btn" data-filter="bandcamp">
                Bandcamp <span id="bandcampCount"></span>
            </button>
            <button class="filter-btn" data-filter="youtube">
                YouTube <span id="youtubeCount"></span>
            </button>
        </div>

        <div class="items-count" id="itemsCount">Loading...</div>

        <div class="music-grid" id="musicGrid">
            <div class="loading">Loading music library</div>
        </div>
    </div>

    <div id="bandcampPlayer">
        <div id="playerLabel">
            ‚ñ∂Ô∏è Now Playing
            <button class="player-close" id="playerClose" title="Close player">√ó</button>
        </div>
        <iframe 
            id="bandcampIframe"
            style="border: 0; width: 100%; height: 350px;"
            src=""
            seamless>
        </iframe>
        <iframe 
            id="youtubeIframe"
            style="border: 0; width: 100%; height: 350px;"
            src=""
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
        </iframe>
    </div>

    <button class="debug-toggle" onclick="toggleDebug()">üêõ Debug</button>
    <div class="debug-info" id="debugInfo"></div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let youtubePlayer = null;
        let youtubeAPIReady = false;
        let currentPlaylistId = null;
        let debugMode = false;

        // YouTube API Ready callback
        function onYouTubeIframeAPIReady() {
            youtubePlayer = new YT.Player('youtubeIframe', {
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
            youtubeAPIReady = true;
            logDebug('YouTube API Ready');
        }

        function onPlayerReady(event) {
            logDebug('YouTube Player Ready');
        }

        function onPlayerError(event) {
            logDebug(`YouTube Player Error: ${event.data}`);
        }

        function onPlayerStateChange(event) {
            try {
                if (event.data === YT.PlayerState.ENDED) {
                    logDebug('YouTube video ended, playing next...');
                    playNextTrack();
                }
            } catch (e) {
                console.warn('YouTube state change error:', e);
            }
        }

        // Enhanced YouTube URL parsing with playlist support
        function parseYouTubeUrl(url) {
            try {
                const u = new URL(url);
                const result = {
                    videoId: null,
                    playlistId: null,
                    playlistIndex: null
                };

                if (u.hostname.includes('youtube.com')) {
                    // Extract video ID
                    if (u.searchParams.get('v')) {
                        result.videoId = u.searchParams.get('v');
                    }
                    
                    // Extract playlist ID
                    if (u.searchParams.get('list')) {
                        result.playlistId = u.searchParams.get('list');
                    }
                    
                    // Extract playlist index
                    if (u.searchParams.get('index')) {
                        result.playlistIndex = parseInt(u.searchParams.get('index'));
                    }
                    
                    // Handle embed URLs
                    if (!result.videoId) {
                        const parts = u.pathname.split('/');
                        const embedIndex = parts.indexOf('embed');
                        if (embedIndex !== -1 && parts[embedIndex + 1]) {
                            result.videoId = parts[embedIndex + 1];
                        }
                    }
                } else if (u.hostname === 'youtu.be') {
                    result.videoId = u.pathname.replace('/', '');
                    if (u.searchParams.get('list')) {
                        result.playlistId = u.searchParams.get('list');
                    }
                    if (u.searchParams.get('index')) {
                        result.playlistIndex = parseInt(u.searchParams.get('index'));
                    }
                }

                return result;
            } catch (e) {
                console.warn('Could not parse YouTube URL:', url, e);
                return { videoId: null, playlistId: null, playlistIndex: null };
            }
        }

        function logDebug(message, data = null) {
            if (debugMode) {
                const debugInfo = document.getElementById('debugInfo');
                const timestamp = new Date().toLocaleTimeString();
                let logEntry = `[${timestamp}] ${message}`;
                if (data) {
                    logEntry += '\n' + JSON.stringify(data, null, 2);
                }
                debugInfo.innerHTML = logEntry + '\n' + debugInfo.innerHTML;
                // Keep only last 10 entries
                const lines = debugInfo.innerHTML.split('\n');
                if (lines.length > 20) {
                    debugInfo.innerHTML = lines.slice(0, 20).join('\n');
                }
            }
            console.log(message, data || '');
        }

        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debugInfo').classList.toggle('show', debugMode);
        }

        const gradients = ['gradient-1', 'gradient-2', 'gradient-3', 'gradient-4', 'gradient-5', 'gradient-6', 'gradient-7', 'gradient-8'];

        // Generate 365 dramatically different colour themes
        function generateThemes() {
            const themes = [];
            
            // Predefined dramatic colour schemes
            const colourPalettes = [
                // Deep contrasts
                ['#0a0e27', '#1a1f4d'], // Deep Navy
                ['#2d1b00', '#5c3a00'], // Deep Brown
                ['#1a0033', '#3d0070'], // Deep Purple
                ['#001a1a', '#003d3d'], // Deep Teal
                ['#330000', '#660000'], // Deep Red
                ['#001a00', '#003300'], // Deep Green
                ['#1a0d00', '#3d1f00'], // Deep Orange
                ['#0d0d2b', '#1a1a4d'], // Midnight Blue
                ['#2b0d2b', '#4d1a4d'], // Deep Magenta
                ['#002b2b', '#004d4d'], // Deep Cyan
            ];

            // Generate 365 themes with dramatic variations
            for (let i = 0; i < 365; i++) {
                const baseIndex = i % colourPalettes.length;
                const basePalette = colourPalettes[baseIndex];
                
                // Create variations by adjusting hue and intensity
                const variation = (i / 365) * 360;
                const intensity = 0.3 + (Math.sin(i * 0.1) + 1) * 0.35;
                
                themes.push({
                    gradient: `linear-gradient(${variation}deg, ${basePalette[0]} 0%, ${basePalette[1]} 100%)`,
                    opacity: intensity
                });
            }
            
            return themes;
        }

        const themes = generateThemes();
        let currentTheme = Math.floor(Math.random() * themes.length);

        function applyTheme() {
            const theme = themes[currentTheme];
            document.body.style.background = theme.gradient;
            document.body.style.backgroundAttachment = 'fixed';
        }

        // Global variables
        let allItems = [];
        let currentFilter = 'all';
        let lastPlayedTrack = null;
        let allTags = new Set();
        let currentTags = new Set();

        // Load data files
        async function loadData() {
            try {
                const [youtubeData, bandcampData, bandcampImages] = await Promise.all([
                    fetch('youtube_videos.json').then(r => r.json()),
                    fetch('bandcamp_metadata.json').then(r => r.json()),
                    fetch('bandcamp_images.json').then(r => r.json())
                ]);

                // Process YouTube items
                const youtubeItems = youtubeData.map(item => ({
                    ...item,
                    source: 'youtube',
                    tags: item.tags || []
                }));

                // Process Bandcamp items
                const bandcampItems = bandcampData.map(item => {
                    const imageData = bandcampImages.find(img => img.url === item.url);
                    return {
                        ...item,
                        source: 'bandcamp',
                        imageUrl: imageData ? imageData.imageUrl : 'https://f4.bcbits.com/img/a3184525960_10.jpg',
                        tags: item.tags || []
                    };
                });

                allItems = [...youtubeItems, ...bandcampItems];

                // Extract all tags
                allItems.forEach(item => {
                    if (item.tags && Array.isArray(item.tags)) {
                        item.tags.forEach(tag => allTags.add(tag));
                    }
                });

                // Initialize UI
                displayItems();
                setupTagFilters();
                updateCounts();

                logDebug(`Loaded ${allItems.length} items (${youtubeItems.length} YouTube, ${bandcampItems.length} Bandcamp)`);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('musicGrid').innerHTML = '<div class="loading">Error loading music library</div>';
            }
        }

        function setupTagFilters() {
            const tagFilters = document.getElementById('tagFilters');
            const tagInfo = document.getElementById('tagInfo');
            
            if (allTags.size === 0) {
                tagInfo.textContent = 'No tags available';
                return;
            }

            tagInfo.textContent = `${allTags.size} tags available - Filter by genre:`;
            
            // Sort tags alphabetically
            const sortedTags = Array.from(allTags).sort();
            
            // Add clear button if tags are selected
            if (currentTags.size > 0) {
                const clearBtn = document.createElement('button');
                clearBtn.className = 'clear-tags';
                clearBtn.textContent = `Clear (${currentTags.size})`;
                clearBtn.onclick = () => {
                    currentTags.clear();
                    setupTagFilters();
                    displayItems();
                };
                tagFilters.appendChild(clearBtn);
            }

            // Add tag chips
            sortedTags.forEach(tag => {
                const chip = document.createElement('button');
                chip.className = 'tag-chip';
                if (currentTags.has(tag)) {
                    chip.classList.add('active');
                }
                chip.textContent = tag;
                chip.onclick = () => toggleTag(tag);
                tagFilters.appendChild(chip);
            });
        }

        function toggleTag(tag) {
            if (currentTags.has(tag)) {
                currentTags.delete(tag);
            } else {
                currentTags.add(tag);
            }
            setupTagFilters();
            displayItems();
        }

        function displayItems() {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = '';

            let itemsToShow = allItems;

            // Filter by source
            if (currentFilter === 'bandcamp') {
                itemsToShow = allItems.filter(item => item.source === 'bandcamp');
            } else if (currentFilter === 'youtube') {
                itemsToShow = allItems.filter(item => item.source === 'youtube');
            }

            // Filter by tags
            if (currentTags.size > 0) {
                itemsToShow = itemsToShow.filter(item => {
                    if (!item.tags || item.tags.length === 0) return false;
                    return item.tags.some(tag => currentTags.has(tag));
                });
            }

            // Shuffle for variety
            itemsToShow = itemsToShow.sort(() => Math.random() - 0.5);

            // Update count
            document.getElementById('itemsCount').textContent = `Showing ${itemsToShow.length} items`;

            // Create items
            itemsToShow.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'music-item';
                div.style.animationDelay = `${index * 0.02}s`;

                const img = document.createElement('img');
                img.className = 'album-art';
                img.src = item.imageUrl || 'https://via.placeholder.com/300x300/1a1a1a/666?text=No+Image';
                img.alt = item.title;
                img.loading = 'lazy';

                const title = document.createElement('div');
                title.className = 'item-title';
                title.textContent = item.title;
                title.title = item.title;

                const artist = document.createElement('div');
                artist.className = 'item-artist';
                artist.textContent = formatArtistName(item.artist || 'Unknown Artist');
                artist.title = item.artist || 'Unknown Artist';

                const badge = document.createElement('span');
                badge.className = `badge ${item.source}`;
                badge.textContent = item.source;

                div.appendChild(img);
                div.appendChild(title);
                div.appendChild(artist);
                div.appendChild(badge);

                div.addEventListener('click', () => playTrack(item));

                grid.appendChild(div);
            });

            updateRandomButtonVisibility();
        }

        function formatArtistName(name) {
            let formatted = name.replace(/[-_]/g, ' ');
            
            if (!formatted.includes(' ')) {
                formatted = formatted
                    .replace(/and/gi, ' and ')
                    .replace(/the/gi, ' the ')
                    .replace(/of/gi, ' of ')
                    .replace(/\s+/g, ' ')
                    .trim();
            }
            
            return formatted.split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

        function playTrack(item) {
            lastPlayedTrack = item;
            
            if (item.source === 'bandcamp') {
                updateBandcampPlayer(item);
            } else {
                updateYouTubePlayer(item);
            }
            
            logDebug(`Playing: ${item.title}`, item);
        }

        function updateBandcampPlayer(item) {
            const playerContainer = document.getElementById('bandcampPlayer');
            const bandcampIframe = document.getElementById('bandcampIframe');
            const youtubeIframe = document.getElementById('youtubeIframe');
            const label = document.getElementById('playerLabel');

            // Hide YouTube, show Bandcamp
            youtubeIframe.style.display = 'none';
            bandcampIframe.style.display = 'block';
            
            // Stop YouTube player
            if (youtubePlayer && youtubePlayer.stopVideo) {
                try {
                    youtubePlayer.stopVideo();
                } catch(e) {}
            }
            youtubeIframe.src = '';

            const isAlbumView = item.bandcamp_type === 'album';
            
            if (isAlbumView) {
                playerContainer.classList.add('sidebar-mode');
                document.body.classList.add('sidebar-active');
                bandcampIframe.classList.add('album-player');
                youtubeIframe.classList.add('album-player');
                
                label.innerHTML = `
                    üìÄ Album View
                    <button class="player-close" id="playerClose" title="Close player">√ó</button>
                `;
            } else {
                playerContainer.classList.remove('sidebar-mode');
                document.body.classList.remove('sidebar-active');
                bandcampIframe.classList.remove('album-player');
                youtubeIframe.classList.remove('album-player');
                
                label.innerHTML = `
                    ‚ñ∂Ô∏è Now Playing
                    <button class="player-close" id="playerClose" title="Close player">√ó</button>
                `;
            }

            // Re-attach close handler
            document.getElementById('playerClose').addEventListener('click', (e) => {
                e.stopPropagation();
                playerContainer.classList.remove('visible', 'sidebar-mode');
                document.body.classList.remove('sidebar-active');
                bandcampIframe.src = '';
                youtubeIframe.src = '';
                if (youtubePlayer && youtubePlayer.stopVideo) {
                    try { youtubePlayer.stopVideo(); } catch(e) {}
                }
            });

            playerContainer.classList.add('visible');

            const embedUrl = `https://bandcamp.com/EmbeddedPlayer/${item.bandcamp_type}=${item.bandcamp_id}/size=${isAlbumView ? 'large' : 'small'}/bgcol=333333/linkcol=0687f5/tracklist=${isAlbumView ? 'true' : 'false'}/transparent=true/`;
            bandcampIframe.src = embedUrl;
            
            if (!isAlbumView) {
                playerContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function updateYouTubePlayer(item) {
            const playerContainer = document.getElementById('bandcampPlayer');
            const bandcampIframe = document.getElementById('bandcampIframe');
            const youtubeIframe = document.getElementById('youtubeIframe');
            const label = document.getElementById('playerLabel');

            const urlData = parseYouTubeUrl(item.url);
            
            if (!urlData.videoId) {
                console.warn('No videoId found, opening in new tab');
                window.open(item.url, '_blank');
                return;
            }

            logDebug('Parsed YouTube URL', urlData);

            // Hide Bandcamp, show YouTube
            bandcampIframe.style.display = 'none';
            youtubeIframe.style.display = 'block';
            
            // Stop Bandcamp player by clearing iframe
            bandcampIframe.src = '';

            // YouTube uses BOTTOM BAR (not sidebar)
            playerContainer.classList.remove('sidebar-mode');
            document.body.classList.remove('sidebar-active');
            bandcampIframe.classList.remove('album-player');
            youtubeIframe.classList.remove('album-player');

            // Update label
            label.innerHTML = `
                ‚ñ∂Ô∏è Now Playing
                <button class="player-close" id="playerClose" title="Close player">√ó</button>
            `;

            // Re-attach close handler
            document.getElementById('playerClose').addEventListener('click', (e) => {
                e.stopPropagation();
                playerContainer.classList.remove('visible', 'sidebar-mode');
                document.body.classList.remove('sidebar-active');
                bandcampIframe.src = '';
                youtubeIframe.src = '';
                if (youtubePlayer && youtubePlayer.stopVideo) {
                    try { youtubePlayer.stopVideo(); } catch(e) {}
                }
                currentPlaylistId = null;
            });

            // Show player
            playerContainer.classList.add('visible');

            // Enhanced YouTube player loading with playlist support
            try {
                if (youtubePlayer && youtubeAPIReady && youtubePlayer.loadVideoById) {
                    if (urlData.playlistId && urlData.playlistIndex) {
                        // Load playlist at specific index
                        logDebug(`Loading playlist ${urlData.playlistId} at index ${urlData.playlistIndex - 1}`);
                        
                        // Store playlist ID for reference
                        currentPlaylistId = urlData.playlistId;
                        
                        // Load the playlist starting at the specific index
                        // Note: YouTube API uses 0-based indexing, but URLs use 1-based
                        youtubePlayer.loadPlaylist({
                            list: urlData.playlistId,
                            listType: 'playlist',
                            index: urlData.playlistIndex - 1, // Convert to 0-based index
                            startSeconds: 0
                        });
                    } else {
                        // Load single video
                        logDebug(`Loading single video ${urlData.videoId}`);
                        youtubePlayer.loadVideoById(urlData.videoId);
                        currentPlaylistId = null;
                    }
                } else {
                    // Fallback to iframe src method with enhanced parameters
                    let embedUrl = `https://www.youtube.com/embed/${urlData.videoId}?autoplay=1&rel=0&modestbranding=1&enablejsapi=1`;
                    
                    if (urlData.playlistId) {
                        embedUrl += `&list=${urlData.playlistId}`;
                        if (urlData.playlistIndex) {
                            embedUrl += `&index=${urlData.playlistIndex}`;
                        }
                        currentPlaylistId = urlData.playlistId;
                    } else {
                        currentPlaylistId = null;
                    }
                    
                    logDebug(`Fallback embed URL: ${embedUrl}`);
                    youtubeIframe.src = embedUrl;
                }
            } catch (e) {
                console.warn('YouTube player error:', e);
                // Final fallback
                let embedUrl = `https://www.youtube.com/embed/${urlData.videoId}?autoplay=1&rel=0&modestbranding=1&enablejsapi=1`;
                if (urlData.playlistId) {
                    embedUrl += `&list=${urlData.playlistId}`;
                    if (urlData.playlistIndex) {
                        embedUrl += `&index=${urlData.playlistIndex}`;
                    }
                }
                youtubeIframe.src = embedUrl;
            }

            playerContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function playNextTrack() {
            let source = currentFilter;
            let pool = [];

            if (source === 'all') {
                const bc = allItems.filter(i => i.source === 'bandcamp' && i.bandcamp_id && i.bandcamp_type);
                const yt = allItems.filter(i => i.source === 'youtube');
                pool = [...bc, ...yt];
            } else if (source === 'bandcamp') {
                pool = allItems.filter(i => i.source === 'bandcamp' && i.bandcamp_id && i.bandcamp_type);
            } else if (source === 'youtube') {
                pool = allItems.filter(i => i.source === 'youtube');
            }

            if (currentTags.size > 0 && pool.length > 0) {
                const tagFiltered = pool.filter(i => {
                    if (!i.tags || i.tags.length === 0) return false;
                    return i.tags.some(tag => currentTags.has(tag));
                });
                if (tagFiltered.length > 0) pool = tagFiltered;
            }

            if (lastPlayedTrack && pool.length > 1) {
                pool = pool.filter(i => i.url !== lastPlayedTrack.url);
            }

            if (pool.length === 0) return;

            const next = pool[Math.floor(Math.random() * pool.length)];
            playTrack(next);
        }

        function updateCounts() {
            const bandcampItems = allItems.filter(i => i.source === 'bandcamp');
            const youtubeItems = allItems.filter(i => i.source === 'youtube');
            
            document.getElementById('allCount').textContent = `(${allItems.length})`;
            document.getElementById('bandcampCount').textContent = `(${bandcampItems.length})`;
            document.getElementById('youtubeCount').textContent = `(${youtubeItems.length})`;
        }

        function updateRandomButtonVisibility() {
            const randomBtn = document.getElementById('randomTrackBtn');
            if (currentFilter !== 'all' || currentTags.size > 0) {
                randomBtn.classList.add('visible');
            } else {
                randomBtn.classList.remove('visible');
            }
        }

        // Event Listeners
        document.getElementById('themeToggle').addEventListener('click', () => {
            currentTheme = (currentTheme + 1) % themes.length;
            applyTheme();
        });

        document.getElementById('randomTrackBtn').addEventListener('click', () => {
            let pool = [];
            
            if (currentFilter === 'all') {
                pool = allItems;
            } else if (currentFilter === 'bandcamp') {
                pool = allItems.filter(i => i.source === 'bandcamp' && i.bandcamp_id && i.bandcamp_type);
            } else if (currentFilter === 'youtube') {
                pool = allItems.filter(i => i.source === 'youtube');
            }

            if (currentTags.size > 0 && pool.length > 0) {
                const tagFiltered = pool.filter(i => {
                    if (!i.tags || i.tags.length === 0) return false;
                    return i.tags.some(tag => currentTags.has(tag));
                });
                if (tagFiltered.length > 0) pool = tagFiltered;
            }

            if (lastPlayedTrack && pool.length > 1) {
                pool = pool.filter(i => i.url !== lastPlayedTrack.url);
            }

            if (pool.length === 0) {
                alert('No tracks available with current filters');
                return;
            }

            const randomItem = pool[Math.floor(Math.random() * pool.length)];
            playTrack(randomItem);
        });

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                displayItems();
            });
        });

        // Initialize
        applyTheme();
        loadData();

        // Listen for YouTube iframe messages (backup for state changes)
        window.addEventListener('message', function(event) {
            if (event.origin !== 'https://www.youtube.com') return;
            
            try {
                const data = JSON.parse(event.data);
                if (data.event === 'onStateChange' && data.info === 0) {
                    logDebug('YouTube video ended (via postMessage), playing next...');
                    playNextTrack();
                }
            } catch (e) {
                // Ignore parse errors
            }
        });
    </script>
</body>
</html>
